<h2 class="pull-right text-right">
  {{tests.length}} tests
  <br>
  <small class="text-muted">
    <span class="label label-success">{{ validTestsNb }}</span>
    | <span class="label label-warning">{{ warningTestsNb }}</span>
    | <span class="label label-danger">{{ errorTestsNb }}</span>
  </small>
</h2>

<p style="margin-top: 10px;">
  <button
    type="button"
    class="btn btn-default"
    ng-if="user.isAdmin"
    ng-click="launchAll()"
    ng-disabled="pendingTests">
    <i class="fa fa-spinner fa-spin" ng-if="pendingTests"></i>
    Lancer tous les tests
  </button>
</p>

<div class="clearfix"></div>

<accordion close-others="false">
  <accordion-group
    is-open="test.open"
    ng-class="{'panel-success': test.status === 'ok',
              'panel-danger': test.status === 'ko',
              'panel-warning': test.status === 'near'}"
    ng-repeat="test in tests">
    <accordion-heading>
      <span class="test-is-valid" ng-if="!readOnly">
        <i ng-if="test.state === 'validated'" class="fa fa-check-circle" tooltip="Test validé"></i>
        <i ng-if="test.state === 'pending'" class="fa fa-clock-o" tooltip="Test en attente de validation"></i>
        <i ng-if="test.state === 'rejected'" class="fa fa-exclamation-circle" tooltip="Test refusé"></i>
      </span>
      <span style="color: grey;" ng-if="test.keywords.length">
        <span ng-repeat="keyword in test.keywords">[{{keyword}}] </span>
      </span>
      {{ test.name }}
      <span class="anchor" id="test-{{ test._id }}">x</span>
    </accordion-heading>
    <small class="text-muted pull-left">
      <span ng-if="test.createdAt">
        Créé le {{test.createdAt}}
      </span>
      <span ng-if="test.user">
       par {{test.user.firstName}} {{test.user.lastName}}
      </span>
      <div ng-if="test.updatedAt">
        Dernière mise à jour le {{test.updatedAt}}
      </div>
    </small>

    <div ng-if="!readOnly">
      <div class="test-actions text-right">
        <div class="btn-group">
          <button type="button" class="btn btn-default btn-xs" ng-disabled="test.state === 'validated'" ng-click="validateTest(test)">
            <i class="fa fa-check text-success"></i> Valider
          </button>
          <button type="button" class="btn btn-default btn-xs" ng-disabled="test.state === 'pending'" ng-click="setPendingTest(test)">
            <i class="fa fa-undo text-info"></i> Mettre en attente
          </button>
          <button type="button" class="btn btn-default btn-xs" ng-disabled="test.state === 'rejected'" ng-click="rejectTest(test)">
            <i class="fa fa-times text-danger"></i> Refuser
          </button>
        </div>

        <div class="btn-group">
          <a class="btn btn-default btn-xs" ui-sref="edit({testId: test._id})">
            <i class="fa fa-edit text-warning"></i> Modifier
          </a>
          <button type="button" class="btn btn-default btn-xs" ng-click="deleteTest(test)">
            <i class="fa fa-times text-danger"></i> Supprimer
          </button>
        </div>

        <button type="button" class="btn btn-default btn-xs" ng-disabled="test.running" ng-click="launch(test)">
          <span ng-if="test.running"><i class="fa fa-spinner fa-spin"></i> En cours...</span>
          <span ng-if="!test.running"><i class="fa fa-play text-primary"></i> Relancer</span>
        </button>
      </div>

      <p class="alert alert-warning-inverse" ng-if="test.rejectionMessage">
        <i class="fa fa-exclamation-triangle"></i>
        <strong>Commentaire :</strong>
        {{ test.rejectionMessage }}
      </p>
    </div>

    <p ng-if="test.displayDescription" ng-bind-html-safe="test.displayDescription"></p>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Droit</th>
          <th>Valeur attendue</th>
          <th>Valeur obtenue</th>
        </tr>
      </thead>
      <tbody>
        <tr ng-repeat="expectedResult in test.expectedResults"
          ng-class="{'success': expectedResult.displayStatus === 'ok',
                    'danger': expectedResult.displayStatus === 'ko',
                    'info': expectedResult.displayStatus === 'unknown',
                    'warning': expectedResult.displayStatus === 'near'}">
          <td>{{ expectedResult.displayLabel }}</td>
          <td>{{ expectedResult.displayExpected }}</td>
          <td>{{ expectedResult.displayResult }}</td>
        </tr>
      </tbody>
    </table>

    <p class="detail-situation">
      <button type="button" class="btn btn-default btn-xs" ng-click="toggleSituation(test)">
        Détail de la situation
        <i class="fa" ng-class="{'fa-chevron-down': test.showSituation, 'fa-chevron-right': !test.showSituation}"></i>
      </button>
      <button type="button" class="btn btn-default btn-xs" ng-if="!readOnly" ng-click="toggleTimeline(test)">
        Timeline
        <i class="fa" ng-class="{'fa-chevron-down': test.showTimeline, 'fa-chevron-right': !test.showTimeline}"></i>
      </button>
      <small ng-if="!readOnly">
        [<a href="/api/situations/{{ test.situation }}">Situation DDS</a>]
        [<a href="/api/situations/{{ test.situation }}/openfisca-request">Requête OpenFisca</a>]
        [<a href="/api/situations/{{ test.situation }}/openfisca-response">Réponse OpenFisca</a>]
        [<a href="" ng-click="gotoDebugOpenFisca(test.situation)">Debug OpenFisca</a>]
        [<a href="../foyer/simulation/{{ test.situation }}">Page de simulation</a>]
        [<a ui-sref="index.list({testId: test._id})">Permalien</a>]
      </small>
    </p>
    <div class="well" ng-if="test.showSituation">
      <scenario test="test"></scenario>
    </div>
    <div ng-if="test.timeline">
      <activity-timeline activities="test.timeline" ng-if="test.showTimeline && test.timeline"></activity-timeline>
    </div>

  </accordion-group>
</accordion>
